
# 2023 احرازهویت نادرست کاربر

## خاص API

- **قابلیت بهره‌برداری:** آسان
- **میزان شیوع:** متداول
- **قابلیت تشخیص:** متوسط
- **پیامد فنی:** شدید

### خاص کسب‌و‌کار

> دسترسی همه به سیستم احراز هویت موجب می‌شود تا این مکانیزم هدفی آسان و در دسترس برای مهاجمین باشد. با اینکه برای بهره‌برداری از برخی از مشکلات احراز هویت ممکن است مهارت‌های فنی پیشرفته‌تری لازم باشد، ابزارهای بهره‌برداری مرتبط در دسترس هستند. درک نادرست توسعه‌دهندگان نرم‌افزار و مهندسان امنیتی از مفاهیم مرتبط با احراز هویت و پیچیدگی پیاده‌سازی داخلی، منجر به اشتباهاتی در فهم چگونگی کارکرد و اهمیت مسائل احراز هویت می‌شود. این اشتباهات باعث می‌شود که مشکلات مرتبط با احراز هویت به طور گسترده‌تر و را...

### آیا API از نظر احرازهویت نادرست کاربر آسیب‌پذیر است؟

نقاط، توابع و جریان‌های احرازهویت API دارایی‌هایی هستند که بایستی محافظت شوند. همچنین توابع «فراموشی گذرواژه یا بازیابی گذرواژه» نیز بایستی در زمره مکانیزم‌های احرازهویت در نظر گرفته شوند.

یک API از منظر احرازهویت نادرست کاربر، آسیب‌پذیر است اگر:

- اجازه حمله `<LINK>` درج هویت را بدهد که در آن مهاجم از لیستی از نام‌های کاربری و گذرواژه‌های معتبر استفاده می‌نماید.
- بدون استفاده از مکانیزم‌های CAPTCHA یا قفل کردن حساب کاربری اجازه حمله Brute Force روی یک حساب کاربری را بدهد.
- اجازه استفاده از گذرواژه‌های ضعیف را بدهد.
- جزئیات و داده‌های حساس مرتبط با احرازهویت از قبیل توکن‌های اصالت سنجی و گذرواژه‌ها را از طریق URL ارسال نماید.
- اصالت توکن‌ها را به بوته آزمون نگذارد.
- توکن‌ JWT ضعیف یا بدون امضا (“alg”:”none”) را بپذیرد یا تاریخ انقضای آنها را اعتبارسنجی ننماید.
- از گذرواژه‌های آشکار، رمزگذاری نشده یا درهم سازی شده بصورت ضعیف استفاده نماید.
- از کلیدهای رمزگذاری ضعیف بهره ببرد.

علاوه بر این، یک میکروسرویس آسیب‌پذیر است اگر:

- میکروسرویس‌های دیگر بدون احراز هویت به آن دسترسی پیدا کنند.
- از توکن‌های ضعیف یا قابل پیش‌بینی برای اعمال احراز هویت استفاده کند.

## مثال‌هایی از سناریوهای حمله

### سناریو #1

> درج هویت (استفاده از `<LINK>` لیستی از نام‌های کاربری یا گذرواژه‌های شناخته شده) حمله‌ای رایج است. اگر اپلیکیشن از مکانیزم‌های حفاظتی خودکار در مقابل تهدیداتی نظیر درج هویت بهره نبرده باشد، آنگاه اپلیکیشن می‌تواند بعنوان یک پیشگوی گذرواژه یا آزمونگر جهت بررسی صحت اطلاعات هویتی جهت عبور از مکانیزم احرازهویت بکار رود.

برای انجام احراز هویت کاربر، مشتری باید یک درخواست API مشابه مورد زیر را با اطلاعات ورود کاربر، صادر کند:

```json
POST /graphql
{
  "query":"mutation {
    login (username:"<username>"password:"<password>") {
      token
    }
   }"
}
```

> اگر اطلاعات ورود کاربر معتبر باشند، توکن احراز هویت برگشت داده می‌شود که باید در درخواست‌های بعدی هم برای شناسایی کاربر ارائه شود. توجه داشته باشید که فقط ارسال سه درخواست در هر دقیقه مجاز است.

برای اجرای حمله Brute Force به حساب یک قربانی،  به شکل زیر از GraphQL query batching استفاده می‌شود تا بتوان تعداد درخواست‌های ورود بیشتری را به سیستم ارسال نمود:

```json
POST /graphql
[
  {"query":"mutation{login(username:"victim"password:"password"){token}}"}
  {"query":"mutation{login(username:"victim"password:"123456"){token}}"}
  {"query":"mutation{login(username:"victim"password:"qwerty"){token}}"}
  ...
  {"query":"mutation{login(username:"victim"password:"123"){token}}"}
]
```

### سناریو #2

> برای به‌روزرسانی آدرس ایمیل مرتبط با حساب کاربران، مشتریان باید یک درخواست API مانند درخواست زیر را ارسال کنند:

```json
PUT /account
Authorization: Bearer <token>

{ "email": "<new_email_address>" }
```

> از آن‌جایی که این API نیاز به تأیید هویت کاربران از طریق ارائه رمز عبور فعلی آنها ندارد، مهاجم می‌تواند با دریافت توکن احراز هویت، پس از به‌روزرسانی آدرس ایمیل حساب کاربری قربانی، رمز عبور وی را تغییر داده و کنترل حساب کاربری قربانی را به دست بگیرد.

## چگونه از ‌آسیب‌پذیری احرازهویت نادرست کاربر پیشگیری کنیم؟

- حصول اطمینان از آنکه تمامی جریان‌های ممکن برای احراز هویت API (موبایل یا وب، سایر لینک‌هایی که از مکانیزم احرازهویت با یک کلیک و غیره) شناسایی شده است. در این زمینه می‌توانید با توسعه دهندگان و مهندسین مشورت کنید.
- مطالعه و فهم کامل مکانیزم‌های احرازهویت استفاده شده در اپلیکیشن؛ بایستی درنظر داشت که OAuth و کلیدهای API نمی‌توانند بعنوان مکانیزمی برای احرازهویت به شمار آیند.
- در مساله احرازهویت، تولید توکن و ذخیره‌سازی گذرواژه، نباید چرخ را از ابتدا اختراع کرد بلکه بایستی از استانداردها استفاده نمود.
- توابع بازیابی یا فراموشی گذرواژه بایستی از منظر محافظت در مقابل Brute Force، محدودسازی نرخ و قفل شدن حساب کاربری هم ارز با توابع و نقاط ورود در نظر گرفته شود.
- برای عملیات‌ حساس (مانند تغییر آدرس ایمیل مالک حساب/شماره تلفن مربوط به احراز هویت دو عاملی)، نیاز به احراز هویت مجدد می‌باشد.
- از راهنمای `<LINK>` احرازهویت OWASP استفاده شود.
- بکارگیری احرازهویت چندعاملی، در هر جا که امکان داشت.
- برای کاهش حملات درج هویت، Dictionary و Brute force، مکانیزم‌های ضد حمله Brute force را پیاده‌سازی کنید. این مکانیزم‌ها باید سخت‌گیرانه‌تر از مکانیزم‌های معمول محدودیت نرخ در API‌ها باشند.
- برای جلوگیری از حملات brute force بر روی کاربران خاص، مکانیزم‌های `<LINK>` قفل کردن حساب کاربری و استفاده از CAPTCHA و برای افزایش امنیت، روش‌های شناسایی رمزهای عبور ضعیف نیز باید پیاده‌سازی شوند.
- کلید‌های API نباید برای احراز هویت کاربران استفاده شوند و تنها می‌بایست برای احراز هویت `<LINK>` مشتریان API مورد استفاده قرار گیرند.

### مراجع

- [OWASP](https://www.owasp.org/index.php/Credential_stuffing)
- [OWASP Key Management Cheat Sheet](https://www.owasp.org/index.php/Key_Management_Cheat_Sheet)
- [OWASP Authentication Cheatsheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [Credential Stuffing](https://github.com/danielmiessler/SecLists)
- [CWE-204: Observable Response Discrepancy](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/03-Testing_for_Weak_Lock_Out_Mechanism(OTG-AUTHN-003))
- [CWE-307: Improper Restriction of Excessive Authentication Attempts](https://cloud.google.com/endpoints/docs/openapi/when-why-api-key)
